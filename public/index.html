<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI豆仓</title>

  <!-- 熊猫 favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='52'%3E🐼%3C/text%3E%3C/svg%3E">

    <link rel="stylesheet" href="/styles.css">
</head>
<body class="theme-light" data-page="inventory">

  <main class="app-main">
    <section class="page active" id="pageInventory" data-page="inventory">

      <section class="panel" id="alertsPanel">
        <div class="panel-title">
          <h2>库存不足提醒</h2>
        </div>
        <div class="alerts-grid">
          <div class="alert-card">
            <div class="alert-head">
              <h3>库存余量 &lt; <span id="labelCriticalThreshold">300</span></h3>
              <span class="count-badge" id="countLt300">色号数量：0</span>
            </div>
            <div class="pill-list" id="listLt300"></div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-title">
          <h2>库存余量</h2>
          <div class="inventory-meta">
            <span class="meta-chip" id="metaTotal">—</span>
          </div>
        </div>

        <div class="filters inventory-filters">
          <div class="field">
            <label>库存排序</label>
            <div class="sort-row">
              <div class="sort-group">
                <button class="btn-sort" id="btnSortAsc">由少到多</button>
                <button class="btn-sort" id="btnSortDesc">由多到少</button>
              </div>

            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid" id="inventoryGrid"></div>

      </section>
    </section>

    <section class="page" id="pageRecords" data-page="records">

      <section class="records-actions">
        <div class="action-grid">
          <button class="action-card primary" id="btnConsume" type="button">
            <span class="action-title">消耗库存</span>
            <span class="action-desc">AI智能识别 / 手动记录 / CSV文件上传</span>
          </button>
          <button class="action-card secondary" id="btnRestock" type="button">
            <span class="action-title">补充库存</span>
            <span class="action-desc">手动记录 / 批量记录 / CSV文件上传</span>
          </button>
          <button class="action-card tertiary" id="btnPatternCalc" type="button">
            <span class="action-title">待拼图纸计算</span>
            <span class="action-desc">预计算图纸消耗是否超过库存</span>
          </button>
        </div>
      </section>
    </section>

    <section class="page subpage" id="pageConsume" data-page="consume">
      <div class="page-header with-back">
        <button class="back-btn" id="consumeClose" type="button">返回</button>
        <div class="page-title">消耗库存</div>
      </div>

      <section class="panel form-panel" id="consumeDialog">
        <div class="tabs" id="consumeTabs">
          <div class="tab-nav">
            <button type="button" class="tab-btn" data-tab="consume-ai">AI智能统计</button>
            <button type="button" class="tab-btn active" data-tab="consume-manual">手动记录</button>
            <button type="button" class="tab-btn" data-tab="consume-batch">上传文件</button>
          </div>
          <div class="tab-panel active" id="consumeManualPanel">
            <div class="modal-field">
              <label for="consumeManualPattern">图纸名称（选填）</label>
              <input type="text" id="consumeManualPattern" placeholder="建议填写，20字以内" maxlength="20" />
            </div>
            <div class="modal-field">
              <label for="consumeManualCategory">图纸分类</label>
              <select id="consumeManualCategory"></select>
            </div>
            <div class="modal-field">
              <label>上传图纸（选填）</label>
              <div class="file-upload">
                <label class="file-upload-label" for="consumeManualImage">
                  <span class="file-upload-title">选择图纸</span>
                  <span class="file-upload-desc">支持 JPG/PNG/WebP，将压缩后上传</span>
                  <span class="file-upload-filename" id="consumeManualImageName">未选择图纸</span>
                </label>
                <input type="file" id="consumeManualImage" accept="image/png,image/jpeg,image/webp" />
              </div>
            </div>
            <div class="modal-field">
              <label>单次最多支持添加 100 条记录，每条记录需填写色号和数量</label>
              <div class="record-rows" id="consumeManualRows"></div>
              <div class="help" id="consumeManualSummary" style="margin-top:4px;font-weight:600;">
                已填写色号：0 个 · 拼豆合计：0 粒
              </div>
            </div>
            <div class="modal-field">
              <button id="consumeAddRow" type="button">+ 添加一行</button>
            </div>
          </div>

          <div class="tab-panel" id="consumeBatchPanel">
            <div class="modal-field">
              <label for="consumeBatchPattern">图纸名称（选填）</label>
              <input type="text" id="consumeBatchPattern" placeholder="建议填写，20字以内" maxlength="20" />
            </div>
            <div class="modal-field">
              <label for="consumeBatchCategory">图纸分类</label>
              <select id="consumeBatchCategory"></select>
            </div>
            <div class="modal-field">
              <label>上传图纸（选填）</label>
              <div class="file-upload">
                <label class="file-upload-label" for="consumeBatchImage">
                  <span class="file-upload-title">选择图纸</span>
                  <span class="file-upload-desc">支持 JPG/PNG/WebP，将压缩后上传</span>
                  <span class="file-upload-filename" id="consumeBatchImageName">未选择图纸</span>
                </label>
                <input type="file" id="consumeBatchImage" accept="image/png,image/jpeg,image/webp" />
              </div>
            </div>
            <div class="modal-field">
              <label>上传 CSV 格式文件</label>
              <div class="file-upload">
                <label class="file-upload-label" for="consumeFile">
                  <span class="file-upload-title">选择 CSV 文件</span>
                  <span class="file-upload-desc">CSV 第一列=色号，第二列=消耗数量，示例：F11,500</span>
                  <span class="file-upload-filename" id="consumeFileName">未选择文件</span>
                </label>
                <input type="file" id="consumeFile" accept=".csv,text/csv" />
              </div>
            </div>
          </div>

          <div class="tab-panel" id="consumeAiPanel">
            <div class="modal-field">
              <label for="consumeAiPattern">图纸名称（选填）</label>
              <input type="text" id="consumeAiPattern" placeholder="建议填写，20字以内" maxlength="20" />
            </div>
            <div class="modal-field">
              <label for="consumeAiCategory">图纸分类</label>
              <select id="consumeAiCategory"></select>
            </div>

            <div class="modal-field">
              <label>上传图纸</label>
              <div class="file-upload">
                <label class="file-upload-label" for="consumeAiImage">
                  <span class="file-upload-title">选择图纸</span>
                  <span class="file-upload-desc">支持 JPG/PNG/WebP，仅支持底部有色号统计的图纸</span>
                  <span class="file-upload-filename" id="consumeAiImageName">未选择图纸</span>
                </label>
                <input type="file" id="consumeAiImage" accept="image/png,image/jpeg,image/webp" />
              </div>
            </div>

            <div class="modal-field">
              <div class="quick-group">
                <button id="consumeAiRecognize" type="button" class="btn-secondary">开始识别</button>
                <button id="consumeAiClear" type="button" class="btn-ghost ai-after" style="display:none;">清空结果</button>
                <button id="consumeAiAddRow" type="button" class="btn-ghost ai-after" style="display:none;">+ 添加一行</button>
              </div>
              <div class="help">系统将调用AI大模型自动统计色号和数量，预计需要15秒</div>
            </div>

            <div class="modal-field" id="consumeAiResultWrap" style="display:none;">
              <label>识别结果（可编辑）</label>
              <div class="ai-result-box">
                <table>
                  <thead>
                    <tr>
                      <th style="width: 110px;">色号</th>
                      <th style="width: 110px;">数量</th>
                      <th style="width: 90px;">置信度</th>
                      <th style="width: 80px;">操作</th>
                    </tr>
                  </thead>
                  <tbody id="consumeAiTableBody"></tbody>
                </table>
              </div>
              <div class="empty" id="consumeAiEmpty" style="display:none;">暂无识别结果</div>
              <div class="help" id="consumeAiSummary" style="margin-top:8px;font-weight:600;">
                已识别色号：0 个 · 拼豆合计：0 粒
              </div>
              <div class="help" id="consumeAiUnknown" style="margin-top:6px;"></div>
            </div>
          </div>
        </div>
        <div class="modal-foot">
          <button class="btn-primary" id="consumeConfirm">确认记录</button>
        </div>
      </section>
    </section>

    <section class="page subpage" id="pageRestock" data-page="restock">
      <div class="page-header with-back">
        <button class="back-btn" id="restockClose" type="button">返回</button>
        <div class="page-title">补充库存</div>
      </div>

      <section class="panel form-panel" id="restockDialog">
        <div class="tabs" id="restockTabs">
          <div class="tab-nav">
            <button type="button" class="tab-btn active" data-tab="restock-manual">手动记录</button>
            <button type="button" class="tab-btn" data-tab="restock-bulk">批量记录</button>
            <button type="button" class="tab-btn" data-tab="restock-batch">上传文件</button>
          </div>

          <div class="tab-panel active" id="restockManualPanel">
            <div class="modal-field">
              <label>手动添加补充记录</label>
              <div class="record-rows" id="restockManualRows"></div>
              <div class="help">
                单次最多支持添加 100 条记录，每条记录需填写色号和数量
              </div>
            </div>
            <div class="modal-field">
              <button id="restockAddRow" type="button">+ 添加一行</button>
            </div>
          </div>

          <div class="tab-panel" id="restockBulkPanel">
            <div class="modal-field">
              <div class="help">输入补充的数量，不需要补充的色号留空即可</div>
              <div class="bulk-top">
                <button id="restockBulkAddAll" type="button">一键添加</button>
                <div class="bulk-meta" id="restockBulkMeta">已填写色号：0个 · 拼豆合计：0粒</div>
              </div>
              <div class="bulk-grid" id="restockBulkGrid"></div>
            </div>
          </div>

          <div class="tab-panel" id="restockBatchPanel">
            <div class="modal-field">
              <label>上传 CSV 格式文件</label>
              <div class="file-upload">
                <label class="file-upload-label" for="restockFile">
                  <span class="file-upload-title">选择 CSV 文件</span>
                  <span class="file-upload-desc">CSV 第一列=色号，第二列=补充数量，示例：F11,500</span>
                  <span class="file-upload-filename" id="restockFileName">未选择文件</span>
                </label>
                <input type="file" id="restockFile" accept=".csv,text/csv" />
              </div>
            </div>
          </div>
        </div>

        <div class="modal-foot">
          <button class="btn-secondary" id="restockConfirm">确认补充</button>
        </div>
      </section>
    </section>

    <section class="page subpage" id="pagePatternCalc" data-page="pattern-calc">
      <div class="page-header with-back">
        <button class="back-btn" id="patternCalcClose" type="button">返回</button>
        <div class="page-title">待拼图纸计算</div>
        <button class="back-btn header-action-btn" id="patternCalcTodoEntry" type="button">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M4 6h16"/>
            <path d="M4 12h10"/>
            <path d="M4 18h16"/>
          </svg>
          待拼图纸
        </button>
      </div>

      <section class="panel form-panel" id="patternCalcDialog">
        <div class="modal-field">
          <div class="file-upload">
            <label class="file-upload-label" for="patternCalcImage">
              <span class="file-upload-title">选择图纸</span>
              <span class="file-upload-desc">支持 JPG/PNG，仅支持底部有色号统计的图纸</span>
              <span class="file-upload-filename" id="patternCalcImageName">未选择图纸</span>
            </label>
            <input type="file" id="patternCalcImage" accept="image/*" />
          </div>
        </div>

        <div class="modal-field">
          <div class="quick-group">
            <button id="patternCalcRecognize" type="button" class="btn-secondary">开始计算</button>
            <button id="patternCalcClear" type="button" class="btn-ghost" style="display:none;">清空结果</button>
            <button id="patternCalcAddTodo" type="button" class="btn-primary" style="display:none;">添加待拼</button>
          </div>
          <div class="help">系统将调用AI统计色号与数量，并与当前库存对比（支持多次补充计算，结果自动合并）</div>
        </div>

        <div class="modal-field" id="patternCalcResultWrap" style="display:none;">
          <label>计算结果（按消耗数量从高到低排序）</label>
          <div class="calc-toolbar">
            <span class="meta-chip" id="patternCalcTotalChip">总消耗：0</span>
            <span class="meta-chip" id="patternCalcCountChip">色号：0</span>
            <span class="meta-chip" id="patternCalcShortChip">不足：0</span>
          </div>
          <div class="calc-table">
            <div class="calc-row calc-head">
              <div>色号</div>
              <div class="num">需要消耗</div>
              <div class="num">当前库存</div>
              <div class="num">拼完剩余</div>
            </div>
            <div id="patternCalcList" class="calc-list"></div>
            <div class="empty" id="patternCalcEmpty" style="display:none;">暂无识别结果</div>
          </div>
          <div class="help" id="patternCalcUnknown" style="margin-top:6px;"></div>
        </div>
      </section>
    </section>

    <section class="page subpage" id="pageTodo" data-page="todo">
      <div class="page-header with-back">
        <button class="back-btn" id="todoListClose" type="button">返回</button>
        <div class="page-title">待拼图纸</div>
      </div>

      <section class="panel" id="todoDialog">
        <div class="category-tabs" id="todoCategoryBar">
          <div class="category-scroll" id="todoCategoryList" aria-label="图纸分类"></div>
        </div>
        <div class="records-table records-consume">
          <div id="todoList" class="records-list"></div>
          <div class="empty" id="todoEmpty" style="display:none;"></div>
        </div>
      </section>
    </section>

    <section class="page" id="pageStats" data-page="stats">

      <section class="panel" id="recordsDialog">
        <div class="tabs" id="recordsTabs">
          <div class="tab-nav">
            <button type="button" class="tab-btn active" data-tab="records-consume">消耗记录</button>
            <button type="button" class="tab-btn" data-tab="records-restock">补充记录</button>
            <button type="button" class="tab-btn" data-tab="records-stats">补豆助手</button>
          </div>
          <div class="category-tabs" id="recordsCategoryBar">
            <div class="category-scroll" id="recordsCategoryList" aria-label="图纸分类"></div>
          </div>

          <div class="tab-panel active" id="recordsConsumePanel">
            <div class="records-table records-consume">
              <div id="recordsConsumeList" class="records-list"></div>
              <div class="empty" id="recordsConsumeEmpty" style="display:none;">暂无消耗记录</div>
            </div>
          </div>

          <div class="tab-panel" id="recordsRestockPanel">
            <div class="records-table records-restock">
              <div id="recordsRestockList" class="records-list"></div>
              <div class="empty" id="recordsRestockEmpty" style="display:none;">暂无补充记录</div>
            </div>
          </div>

          <div class="tab-panel" id="recordsStatsPanel">
            <div class="records-toolbar stats-toolbar stats-cards">
              <div class="stats-card">
                <div class="stats-card-label">总消耗</div>
                <div class="stats-card-value" id="recordsStatsTotalChip">0</div>
              </div>
              <div class="stats-card">
                <div class="stats-card-label">消耗色号</div>
                <div class="stats-card-value" id="recordsStatsCountChip">0</div>
              </div>
            </div>
            <div class="stats-table">
              <div class="stats-row stats-head">
                <div>排名</div>
                <div>色号</div>
                <div class="num">消耗</div>
                <div class="num">当前库存</div>
              </div>
              <div id="recordsStatsList" class="stats-list"></div>
              <div class="empty" id="recordsStatsEmpty" style="display:none;">暂无消耗</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <section class="page" id="pageMe" data-page="me">

      <section class="panel">
        <div class="panel-title">
          <h2>账户</h2>
        </div>
        <div class="account-actions">
          <div class="account-row">
            <button class="btn-ghost" id="btnAuth" type="button">登录</button>
            <button class="btn-ghost" id="btnLogout" type="button">退出</button>
          </div>
          <div class="help" id="accountHelp">登录后库存与记录会同步到云端</div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-title">
          <h2>黑夜模式</h2>
          <div class="me-actions">
            <button class="btn-ghost" id="btnTheme" type="button" title="切换深浅色" aria-label="切换深浅色">打开黑夜模式</button>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-title">
          <h2>库存提醒设置</h2>
        </div>
        <div class="modal-field">
          <label for="criticalInput">提醒数量（默认 300）余量低于该值时会出现在“库存提醒”的列表，并标记为库存紧张</label>
          <div class="inline-field">
            <input type="number" id="criticalInput" min="1" step="1" />
            <div class="settings-actions">
              <button class="btn-primary" id="settingsPrimary">保存</button>
            </div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-title">
          <h2>图纸分类</h2>
        </div>
        <div class="modal-field">
          <div class="inline-field">
            <input id="patternCategoryInput" type="text" maxlength="12" placeholder="例如：卡通（最多6个字）" />
            <div class="settings-actions">
              <button id="patternCategoryAdd" class="btn-primary" type="button">新增分类</button>
            </div>
          </div>
        </div>
        <div id="patternCategoryList" class="category-list"></div>
      </section>

      <section class="panel">
        <div class="panel-title">
          <h2>添加色号</h2>
        </div>
        <div class="modal-field">
          <label for="addCodeInput">可添加MARD色号，默认库存为0</label>
          <div class="inline-field">
            <input id="addCodeInput" type="text" maxlength="6" placeholder="例如：F11" />
            <div class="settings-actions">
              <button id="addCodeSubmit" class="btn-primary" type="button">保存</button>
            </div>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-title">
          <h2>色系管理</h2>
        </div>
        <div class="modal-field">
          <label>添加/删除非标准色系</label>
          <div id="seriesList" class="series-list"></div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-title">
          <h2>导出数据</h2>
        </div>
        <div class="export-row">
          <button class="btn-secondary" id="btnExport" type="button">导出数据</button>
          <div class="help">建议定期导出 CSV 备份库存数据</div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-title">
          <h2>重置库存</h2>
        </div>
        <div class="export-row">
          <button class="btn-secondary" id="btnResetAll" type="button">重置库存</button>
          <div class="help">将库存恢复至默认状态</div>
        </div>
      </section>

      <div class="help me-footer-note">本系统由@王雷奥 搭建，问题和建议请在小红书主页群反馈</div>
    </section>
  </main>

  <nav class="tabbar" id="appTabbar" aria-label="底部导航">
    <button class="tabbar-btn active" data-tab="inventory" type="button" aria-label="库存">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 7h16v10H4z"/><path d="M7 7V4h10v3"/></svg>
      <span class="tab-label">库存</span>
    </button>
    <button class="tabbar-btn" data-tab="records" type="button" aria-label="记录">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 3h10a2 2 0 0 1 2 2v14l-4-3H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/></svg>
      <span class="tab-label">记录</span>
    </button>
    <button class="tabbar-btn" data-tab="stats" type="button" aria-label="统计">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12h3v7H5z"/><path d="M11 5h3v14h-3z"/><path d="M17 9h3v10h-3z"/></svg>
      <span class="tab-label">统计</span>
    </button>
    <button class="tabbar-btn" data-tab="me" type="button" aria-label="我的">
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="8" r="4"/><path d="M4 20c1.8-4 13.2-4 16 0"/></svg>
      <span class="tab-label">我的</span>
    </button>
  </nav>

  <!-- 移动端悬浮导航（滚动一屏后出现） -->
  <div class="float-nav" id="mobileFloatNav" hidden aria-label="快捷导航">
    <button class="icon-btn" id="navToTop" title="回到顶部" aria-label="回到顶部"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 19V5"/><path d="M7 10l5-5 5 5"/><path d="M5 3h14"/></svg></button>
    <button class="icon-btn" id="navPrevSeries" title="上一个色系" aria-label="上一个色系"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 14l6-6 6 6"/></svg></button>
    <button class="icon-btn" id="navNextSeries" title="下一个色系" aria-label="下一个色系"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 10l6 6 6-6"/></svg></button>
  </div>

  <!-- 明细弹窗 -->
  <dialog id="detailDialog">
    <div class="modal-head">
      <h3 id="detailTitle">色号明细</h3>
      <div class="modal-head-actions">
        <button id="detailDelete" class="btn-danger" type="button">删除色号</button>
        <button id="detailClose" type="button">关闭</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="filters" style="grid-template-columns: 1fr 1fr 1fr; gap: 8px 10px;">
        <span class="meta-chip" id="detailRemain">—</span>
        <span class="meta-chip" id="detailTotalConsume">—</span>
        <span class="meta-chip" id="detailTotalRestock">—</span>
      </div>
      <div>
        <table>
          <thead>
            <tr>
              <th style="width: 96px;">时间</th>
              <th style="width: 56px;">操作</th>
              <th style="width: 56px;">数量</th>
              <th>图纸名称</th>
            </tr>
          </thead>
          <tbody id="detailTableBody"></tbody>
        </table>
        <div class="empty" id="detailEmpty" style="display:none;">暂无记录</div>
      </div>
    </div>
  </dialog>

  <!-- 删除色号（二次确认） -->
  <dialog id="deleteColorDialog">
    <div class="modal-head">
      <h3>删除色号</h3>
      <button id="deleteColorClose" type="button">关闭</button>
    </div>
    <div class="modal-body">
      <div class="help" style="font-size:12px; line-height:1.6;">
        删除色号将清空库存和明细，是否确认删除？
	      </div>
	    <div class="modal-foot">
      <button id="deleteColorCancel" class="btn-ghost" type="button">取消</button>
      <button id="deleteColorConfirm" class="btn-danger" type="button">确认删除</button>
    </div>
  </dialog>
  <!-- 重置库存 -->
  <dialog id="resetDialog">
    <div class="modal-head">
      <h3>重置库存</h3>
      <button id="resetClose">关闭</button>
    </div>
    <div class="modal-body">
      <div class="help" style="font-size:12px; line-height:1.6;">
        重置库存会将所有色号数量恢复为0，同时清空历史所有补充和消耗记录，请谨慎操作。是否确认重置？
      </div>
    </div>
    <div class="modal-foot">
      <button id="resetCancel" class="btn-ghost" type="button">取消</button>
      <button id="resetConfirm" class="btn-danger" type="button">确认重置</button>
    </div>
  </dialog>




  <!-- 拼豆记录 -->
  <!-- 删除记录二次确认 -->
  <dialog id="recordDeleteDialog">
    <div class="modal-head">
      <h3 id="recordDeleteTitle">删除记录</h3>
      <button id="recordDeleteClose">关闭</button>
    </div>
    <div class="modal-body">
      <div class="help" id="recordDeleteText" style="font-size:12px; line-height:1.6;"></div>
    </div>
    <div class="modal-foot">
      <button id="recordDeleteCancel" class="btn-ghost" type="button">取消</button>
      <button id="recordDeleteConfirm" class="btn-danger" type="button">确认删除</button>
    </div>
  </dialog>

  <!-- 编辑记录 -->
  <dialog id="recordEditDialog">
    <div class="modal-head">
      <h3 id="recordEditTitle">编辑记录</h3>
      <button id="recordEditClose">关闭</button>
    </div>
      <div class="modal-body">
        <div class="modal-field" id="recordEditPatternField">
          <label for="recordEditPattern">图纸名称（选填）</label>
          <input type="text" id="recordEditPattern" placeholder="建议填写，20字以内" maxlength="20" />
        </div>
        <div class="modal-field" id="recordEditCategoryField">
          <label for="recordEditCategory">图纸分类</label>
          <select id="recordEditCategory"></select>
        </div>
        <div class="modal-field" id="recordEditImageField">
          <label>图纸图片（选填）</label>
          <div class="file-upload">
            <label class="file-upload-label" for="recordEditImage">
            <span class="file-upload-title">重新上传图纸</span>
            <span class="file-upload-desc">支持 JPG/PNG/WebP，将压缩后上传</span>
            <span class="file-upload-filename" id="recordEditImageName">未选择图纸</span>
          </label>
          <input type="file" id="recordEditImage" accept="image/png,image/jpeg,image/webp" />
        </div>
        <div class="pattern-preview" id="recordEditImagePreview" style="display:none;">
          <img id="recordEditImagePreviewImg" alt="图纸预览" />
        </div>
        <button id="recordEditImageClear" class="btn-ghost" type="button">移除图纸</button>
      </div>
      <div class="modal-field">
        <label>色号与数量</label>
        <div class="record-rows" id="recordEditRows"></div>
        <div class="help">单次最多支持添加 100 条记录</div>
      </div>
      <div class="modal-field">
        <button id="recordEditAddRow" type="button">+ 添加一行</button>
      </div>
    </div>
    <div class="modal-foot">
      <button id="recordEditCancel" class="btn-ghost" type="button">取消</button>
      <button id="recordEditConfirm" class="btn-primary" type="button">保存修改</button>
    </div>
  </dialog>

  <!-- 添加待拼 -->
  <dialog id="todoAddDialog">
    <div class="modal-head">
      <h3>添加待拼</h3>
      <button id="todoAddClose">关闭</button>
    </div>
    <div class="modal-body">
      <div class="modal-field">
        <label for="todoAddPattern">图纸名称（选填）</label>
        <input type="text" id="todoAddPattern" placeholder="建议填写，20字以内" maxlength="20" />
      </div>
      <div class="modal-field">
        <label for="todoAddCategory">图纸分类</label>
        <select id="todoAddCategory"></select>
      </div>
      <div class="modal-field">
        <label>图纸图片</label>
        <div class="help" id="todoAddImageInfo">已使用刚才上传的图纸</div>
      </div>
      <div class="modal-field">
        <label>色号与数量</label>
        <div class="record-rows" id="todoAddRows"></div>
        <div class="help" id="todoAddSummary" style="margin-top:4px;font-weight:600;">已填写色号：0 个 · 拼豆合计：0 粒</div>
      </div>
      <div class="modal-field">
        <button id="todoAddRow" type="button">+ 添加一行</button>
      </div>
    </div>
    <div class="modal-foot">
      <button id="todoAddCancel" class="btn-ghost" type="button">取消</button>
      <button id="todoAddConfirm" class="btn-primary" type="button">确认添加待拼</button>
    </div>
  </dialog>



  <!-- 记录消耗 -->
<!-- 补充 -->
<!-- 调整库存 -->
  <dialog id="adjustDialog">
    <div class="modal-head">
      <h3 id="adjustTitle">调整库存</h3>
      <button id="adjustClose">关闭</button>
    </div>
    <div class="modal-body">
      <div class="modal-field">
        <label for="adjustType">操作类型</label>
        <select id="adjustType">
          <option value="restock">补充</option>
          <option value="consume" selected>消耗</option>
        </select>
      </div>
      <div class="modal-field">
        <label for="adjustQty">数量</label>
        <input type="number" id="adjustQty" placeholder="请输入数量" min="1" step="1" />
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn-secondary" id="adjustConfirm">确认调整</button>
    </div>
  </dialog>

  <!-- 设置：左侧 tab -->
<!-- 未登录提示（仅展示一次） -->
  <dialog id="guestTipDialog">
    <div class="modal-head">
      <h3>提示</h3>
    </div>
        <div class="modal-body">
      <div class="guest-tip-text">
        <p>1.未登录状态下数据仅保存在本地，如需保存至云端请登录后使用</p>
        <p>2.用户名请务必记住，建议使用手机号或邮箱，忘记无法找回！！！</p>
        <p>3.本项目纯属为爱发电，服务器和AI成本由作者本人承担，请定期使用导出功能备份数据，作者不承担数据丢失导致的任何后果</p>
      </div>
      <div class="modal-actions" style="margin-top:14px;">
        <button class="btn-primary" id="guestTipOk">我知道了</button>
      </div>
    </div>
  </dialog>

  <!-- 登录 -->
  <dialog id="loginDialog">
    <div class="modal-head">
      <h3>登录</h3>
      <button id="loginClose">关闭</button>
    </div>
    <div class="modal-body">
      <div class="modal-field">
        <label for="loginUsername">用户名</label>
        <input id="loginUsername" type="text" maxlength="32" placeholder="请输入用户名" />
      </div>
      <div class="modal-field">
        <label for="loginPassword">密码</label>
        <input id="loginPassword" type="password" maxlength="64" placeholder="请输入密码" />
      </div>
      <div class="modal-actions">
        <button class="btn-primary" id="loginSubmit">登录</button>
        <button class="btn-ghost" id="loginToRegister" type="button">没账号？去注册</button>
      </div>
      <div class="help">登录后色号和库存将保存至云端，并可使用AI智能记录</div>
    </div>
  </dialog>

  <!-- 注册 -->
  <dialog id="registerDialog">
    <div class="modal-head">
      <h3>注册</h3>
      <button id="registerClose">关闭</button>
    </div>
    <div class="modal-body">
      <div class="modal-field">
        <label for="registerUsername">用户名</label>
        <input id="registerUsername" type="text" maxlength="32" placeholder="3~32位（中英文/数字/下划线/短横线）" />
      </div>
      <div class="modal-field">
        <label for="registerPassword">密码</label>
        <input id="registerPassword" type="password" maxlength="64" placeholder="至少6位" />
      </div>
      <div class="modal-field">
        <label for="registerPassword2">再次输入密码</label>
        <input id="registerPassword2" type="password" maxlength="64" placeholder="再次输入密码" />
      </div>
      <div class="modal-actions">
        <button class="btn-primary" id="registerSubmit">注册并登录</button>
        <button class="btn-ghost" id="registerToLogin" type="button">去登录</button>
      </div>
      <div class="help">注册成功后默认添加221色号，每个颜色库存为0</div>
    </div>
  </dialog>

<div id="backdrop" class="backdrop" hidden></div>

  <div id="globalLoading" class="loading-overlay" aria-hidden="true" aria-live="polite" role="dialog" aria-modal="true" tabindex="-1">
    <div class="loading-card">
      <div class="loading-spinner" aria-hidden="true"></div>
      <div class="loading-text" id="globalLoadingText">处理中，请稍候…</div>
    </div>
  </div>

  <div class="toast-stack" id="toastStack" aria-live="polite" aria-atomic="true"></div>

    <script defer src="/app.js"></script>
  <script>    // ----- OSS SDK lazy loader -----
    const OSS_SDK_URL = "https://cdn.jsdelivr.net/npm/ali-oss@6.20.0/dist/aliyun-oss-sdk.min.js";
    const OSS_SDK_TIMEOUT_MS = 10000;
    let OSS_SDK_PROMISE = null;
    let OSS_SDK_TOAST_SHOWN = false;

    function _loadOssSdkOnce(){
      return new Promise((resolve, reject)=>{
        if(window.OSS) return resolve();
        const script = document.createElement("script");
        let done = false;
        const cleanup = (err)=>{
          if(done) return;
          done = true;
          if(timer) clearTimeout(timer);
          script.onload = null;
          script.onerror = null;
          if(err){
            try{ script.remove(); }catch{}
            reject(err);
          }else{
            resolve();
          }
        };
        const timer = setTimeout(()=>{
          cleanup(new Error(`oss sdk load timeout ${OSS_SDK_TIMEOUT_MS}ms`));
        }, OSS_SDK_TIMEOUT_MS);
        script.async = true;
        script.src = OSS_SDK_URL;
        script.onload = ()=>{
          if(window.OSS){
            cleanup();
          }else{
            cleanup(new Error("oss sdk loaded but window.OSS missing"));
          }
        };
        script.onerror = ()=>{
          cleanup(new Error("oss sdk load error"));
        };
        document.head.appendChild(script);
      });
    }

    function loadOssSdk(){
      if(window.OSS) return Promise.resolve();
      if(OSS_SDK_PROMISE) return OSS_SDK_PROMISE;
      OSS_SDK_PROMISE = _loadOssSdkOnce().catch(err=>{
        OSS_SDK_PROMISE = null;
        throw err;
      });
      return OSS_SDK_PROMISE;
    }

    function warmupOssSdk(){
      const runner = () => loadOssSdk().catch((err)=>console.warn("[OSS SDK] warmup failed", err));
      if(typeof requestIdleCallback === "function"){
        requestIdleCallback(runner);
      }else{
        setTimeout(runner, 300);
      }
    }

    // ----- OSS upload helpers (STS) -----
    const OSS_STATE = {
      client: null,
      expiration: 0,
      uploadPrefix: "",
      cdnBaseUrl: "https://img.leobeads.xyz"
    };
    const OSS_ALLOWED_TYPES = new Set(["image/jpeg","image/png","image/webp"]);
    const OSS_ALLOWED_EXT = new Set(["jpg","jpeg","png","webp"]);

    function normalizeUploadPrefix(prefix){
      const base = String(prefix || "").replace(/^\/+|\/+$/g, "");
      return base ? `${base}/` : "";
    }
    function inferImageExt(file){
      const name = String(file?.name || "");
      const m = name.match(/\.([a-zA-Z0-9]+)$/);
      let ext = m ? m[1].toLowerCase() : "";
      if(ext === "jpeg") ext = "jpg";
      if(OSS_ALLOWED_EXT.has(ext)) return ext;
      const mime = String(file?.type || "").toLowerCase();
      if(mime.includes("jpeg")) return "jpg";
      if(mime.includes("png")) return "png";
      if(mime.includes("webp")) return "webp";
      return "jpg";
    }
    function isAllowedImageFile(file){
      if(!file) return false;
      const mime = String(file.type || "").toLowerCase();
      if(OSS_ALLOWED_TYPES.has(mime)) return true;
      const ext = inferImageExt(file);
      return OSS_ALLOWED_EXT.has(ext);
    }
    function getTargetImageType(){
      return "image/webp";
    }
    function newUploadUuid(){
      try{
        if(window.crypto && typeof window.crypto.randomUUID === "function"){
          return window.crypto.randomUUID();
        }
      }catch{}
      return Math.random().toString(16).slice(2) + "-" + Math.random().toString(16).slice(2);
    }
    function buildDateStamp(d){
      return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}`;
    }
    function buildObjectKey(prefix, ext){
      const now = new Date();
      const datePart = buildDateStamp(now);
      const ts = Date.now();
      const id = newUploadUuid();
      const safePrefix = normalizeUploadPrefix(prefix);
      return `${safePrefix}${datePart}/${ts}-${id}.${ext || "jpg"}`;
    }
    function loadImageFromFile(file){
      return new Promise((resolve, reject)=>{
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = ()=>{
          URL.revokeObjectURL(url);
          resolve(img);
        };
        img.onerror = ()=>{
          URL.revokeObjectURL(url);
          reject(new Error("读取图片失败"));
        };
        img.src = url;
      });
    }
    async function compressImageFile(file){
      const img = await loadImageFromFile(file);
      const maxDim = 1024;
      const scale = Math.min(1, maxDim / Math.max(img.width || 1, img.height || 1));
      const targetW = Math.max(1, Math.round((img.width || 1) * scale));
      const targetH = Math.max(1, Math.round((img.height || 1) * scale));
      const canvas = document.createElement("canvas");
      canvas.width = targetW;
      canvas.height = targetH;
      const ctx = canvas.getContext("2d");
      if(ctx){
        ctx.drawImage(img, 0, 0, targetW, targetH);
      }
      const targetType = getTargetImageType(file);
      const quality = 0.5;
      const blob = await new Promise(resolve=>canvas.toBlob(resolve, targetType, quality));
      const fallbackExt = inferImageExt(file);
      const fallbackMime = file.type || (fallbackExt === "png" ? "image/png" : (fallbackExt === "webp" ? "image/webp" : "image/jpeg"));
      if(!blob || (Number.isFinite(file.size) && file.size > 0 && blob.size > file.size)){
        return { blob: file, ext: fallbackExt, mime: fallbackMime };
      }
      const ext = targetType === "image/webp" ? "webp" : (targetType === "image/png" ? "png" : "jpg");
      return { blob, ext, mime: targetType };
    }
    async function fetchOssSts(){
      const res = await apiGet("/api/oss/sts");
      const data = res?.data || res;
      if(!data || !data.accessKeyId || !data.accessKeySecret || !data.securityToken){
        throw new Error("OSS 凭证获取失败");
      }
      return data;
    }
    async function ensureOssClient(){
      if(!IS_LOGGED_IN) throw new Error("请登录后上传图纸");
      if(!window.OSS){
        if(!OSS_SDK_TOAST_SHOWN){
          OSS_SDK_TOAST_SHOWN = true;
          toast("上传组件加载中，请稍候...","info");
        }
        try{
          await loadOssSdk();
        }catch(e){
          OSS_SDK_TOAST_SHOWN = false;
          throw new Error("上传组件加载失败，请检查网络后重试");
        }
      }
      OSS_SDK_TOAST_SHOWN = false;
      if(!window.OSS){
        throw new Error("上传组件加载失败，请检查网络后重试");
      }
      const now = Date.now();
      if(OSS_STATE.client && OSS_STATE.expiration - now > 60 * 1000){
        return OSS_STATE;
      }
      const data = await fetchOssSts();
      OSS_STATE.client = new window.OSS({
        region: data.region,
        bucket: data.bucket,
        endpoint: data.endpoint,
        cname: !!data.cname,
        secure: true,
        accessKeyId: data.accessKeyId,
        accessKeySecret: data.accessKeySecret,
        stsToken: data.securityToken
      });
      OSS_STATE.expiration = Date.parse(data.expiration || "") || 0;
      OSS_STATE.uploadPrefix = String(data.uploadPrefix || "");
      OSS_STATE.cdnBaseUrl = String(data.cdnBaseUrl || OSS_STATE.cdnBaseUrl);
      return OSS_STATE;
    }
    async function uploadPatternImage(file){
      if(!file) return null;
      if(!isAllowedImageFile(file)) throw new Error("仅支持 JPG/PNG/WebP 图片");
      if(typeof window.showGlobalLoading === "function"){
        window.showGlobalLoading("图片上传中，请稍候…");
      }
      try{
        const oss = await ensureOssClient();
        const prepared = await compressImageFile(file);
        const objectKey = buildObjectKey(oss.uploadPrefix, prepared.ext);
        const mime = prepared.mime || file.type || "image/jpeg";
        const result = await oss.client.multipartUpload(objectKey, prepared.blob, { mime });
        const base = String(oss.cdnBaseUrl || "https://img.leobeads.xyz").replace(/\/+$/g, "");
        const cdnUrl = `${base}/${objectKey}`;
        return {
          objectKey,
          cdnUrl,
          etag: result?.etag || "",
          size: prepared.blob?.size || file.size || 0,
          mime
        };
      }finally{
        if(typeof window.hideGlobalLoading === "function"){
          window.hideGlobalLoading();
        }
      }
    }



</script>
</body>
</html>
