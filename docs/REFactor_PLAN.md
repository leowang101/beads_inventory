# Refactor Plan（仅文档与回归护栏）

> 目标：不改变任何现有接口行为、不改 SQL、不改前端逻辑。以下为接下来的 3 步重构策略与风险控制点。

## 第 1 步：建立基线与回归护栏（已准备）
- 产物：`docs/API_CONTRACT.md`、`scripts/smoke.sh`
- 风险控制点：
  - 任何代码改动前先跑一遍 `smoke.sh`，记录返回结果与关键字段
  - 统一使用固定测试账号，避免数据污染
  - 若 DB 未配置或无法登录，先修复环境再开始重构

## 第 2 步：模块化拆分（保持行为不变）
- 拆分方向：路由层、校验层、数据访问层（DAL），但保持 SQL 与返回结构不变
- 风险控制点：
  - 拆分仅做函数移动与包装，不更改字段名、状态码或错误信息
  - 每完成一个模块拆分立即跑 `smoke.sh` 验证
  - 对关键路径（登录、adjust、history、reset）保持与当前 API Contract 一致

## 第 3 步：结构优化与清理（谨慎推进）
- 方向：重复逻辑提取、错误处理统一、配置集中化
- 风险控制点：
  - 任何“看似等价”的改动都要用 `smoke.sh` 与 API Contract 对照核验
  - 若发现前后输出不一致，优先回滚或隔离到独立分支验证
  - 保留可快速回滚的发布方式（如保留旧入口或旧分支）

